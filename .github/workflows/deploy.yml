- name: Set up SSH key (from base64)
  env:
    SSH_PRIVATE_KEY_B64: ${{ secrets.SSH_PRIVATE_KEY_B64 }}
    SSH_HOST: ${{ secrets.SSH_HOST }}
    SSH_PORT: ${{ secrets.SSH_PORT }}
  run: |
    install -m 700 -d ~/.ssh
    echo "${SSH_PRIVATE_KEY_B64}" | base64 -d > ~/.ssh/deploy_key
    chmod 600 ~/.ssh/deploy_key
    ssh-keyscan -p "${SSH_PORT:-22}" "${SSH_HOST}" >> ~/.ssh/known_hosts
    chmod 644 ~/.ssh/known_hosts

- name: Rsync code to server
  env:
    SSH_HOST: ${{ secrets.SSH_HOST }}
    SSH_USER: ${{ secrets.SSH_USER }}
    SSH_PORT: ${{ secrets.SSH_PORT }}
    DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
  run: |
    RSYNC_EXCLUDES="--exclude '.git' --exclude 'README.md' --exclude '.github'"
    rsync -az --delete $RSYNC_EXCLUDES \
      -e "ssh -i ~/.ssh/deploy_key -p ${SSH_PORT:-22} -o IdentitiesOnly=yes -o StrictHostKeyChecking=yes" \
      ./ "${SSH_USER}@${SSH_HOST}:${DEPLOY_PATH}/"
